<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anfo Word Rush</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Cute font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: linear-gradient(135deg, #fff7f2, #f7f5ff);
      color: #2b2b2b;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.08);
      padding: 18px 18px 24px;
    }

    h1, h2, h3 {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo {
      font-weight: 800;
      font-size: 26px;
      text-align: center;
      margin-bottom: 4px;
      color: #ff8a7a;
      letter-spacing: 0.04em;
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #8a8a8a;
      margin-bottom: 16px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #ff8a7a;
      color: #fff;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
    }

    button:hover {
      background: #ff7a69;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-secondary {
      background: #f3f0ff;
      color: #5b4ea3;
    }

    .btn-secondary:hover {
      background: #e6deff;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .center {
      text-align: center;
    }

    .section {
      margin-bottom: 16px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
    }

    .chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: #f9f4ff;
      font-size: 13px;
      cursor: pointer;
      color: #6b5aa8;
      border: 1px solid transparent;
    }

    .chip.selected {
      background: #ffcfdf;
      color: #b03b6f;
      border-color: #ff9fbf;
    }

    /* Top bar */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    #progress-container {
      flex: 1;
      margin: 0 8px;
      background: #f7e9ff;
      border-radius: 999px;
      height: 10px;
      overflow: hidden;
      position: relative;
    }

    #progress-bar,
    #progress-bar-challenge {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff9fbf, #ffc15e);
      border-radius: 999px;
      transition: width 0.25s ease;
    }

    #progress-label {
      font-size: 11px;
      color: #8a7bb8;
      min-width: 70px;
      text-align: right;
    }

    #timer {
      background: #ffe4dc;
      color: #ff7a59;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    /* Avatar */
    #avatar-container {
      display: flex;
      justify-content: center;
      margin: 10px 0 14px;
    }

    #avatar-learn,
    #avatar-challenge {
      width: 96px;
      height: 96px;
      object-fit: contain;
      transition: transform 0.2s ease;
    }

    .avatar-bounce {
      animation: bounce 0.4s ease;
    }

    @keyframes bounce {
      0% { transform: scale(1); }
      30% { transform: scale(1.1); }
      60% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }

    /* Learn card */
    #learn-card {
      background: #fff7fb;
      border-radius: 18px;
      padding: 14px;
      text-align: center;
      border: 1px solid #ffe0f2;
    }

    #lesson-img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    #lesson-word {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #ff7a7a;
    }

    #lesson-meaning {
      font-size: 15px;
      color: #555;
      margin-bottom: 6px;
    }

    #lesson-sentence {
      font-size: 13px;
      color: #777;
      margin-bottom: 8px;
    }

    .learn-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    /* Challenge */
    #challenge-word {
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      margin: 8px 0 12px;
      color: #ff7a7a;
    }

    #options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .option {
      width: 100%;
      text-align: center;
      font-size: 13px;
      padding: 10px 6px;
      background: #fdf5ff;
      color: #5b4ea3;
      border-radius: 14px;
      border: 1px solid transparent;
    }

    .option.correct {
      background: #e1ffe8;
      color: #1b7a1b;
      border-color: #9be7b0;
    }

    .option.wrong {
      background: #ffe1e1;
      color: #b00020;
      border-color: #ff9b9b;
    }

    /* Result screen */
    #results-list {
      margin-top: 8px;
      font-size: 13px;
      list-style: none;
    }

    #results-list li {
      margin-bottom: 4px;
    }

    .actions-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    /* Responsive */
    @media (max-width: 480px) {
      #app {
        border-radius: 0;
        max-width: 100%;
        height: 100vh;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- START SCREEN -->
    <div id="screen-start" class="screen active">
      <div class="logo">Anfo</div>
      <div class="subtitle">Cute word game for learning English</div>

      <div class="section center">
        <h3>Choose level</h3>
        <div class="chips" id="level-chips">
          <div class="chip selected" data-level="beginner">Beginner</div>
          <div class="chip" data-level="intermediate">Intermediate</div>
        </div>
      </div>

      <div class="section center">
        <h3>Choose topic</h3>
        <div class="chips" id="topic-chips">
          <div class="chip selected" data-topic="daily">Daily</div>
          <div class="chip" data-topic="food">Food</div>
          <div class="chip" data-topic="travel">Travel</div>
        </div>
      </div>

      <div class="section center">
        <button id="btn-start-learn">Start learning</button>
      </div>
    </div>

    <!-- LEARN SCREEN -->
    <div id="screen-learn" class="screen">
      <div id="top-bar">
        <span style="font-size:12px; color:#8a7bb8;">Learn mode</span>
        <div id="progress-container">
          <div id="progress-bar"></div>
        </div>
        <span id="progress-label">0 / 0</span>
      </div>

      <div id="avatar-container">
        <img id="avatar-learn" src="avatar_neutral.png" alt="avatar" />
      </div>

      <div id="learn-card">
        <img id="lesson-img" src="" alt="lesson image" />
        <div id="lesson-word"></div>
        <div id="lesson-meaning"></div>
        <div id="lesson-sentence"></div>
        <div class="learn-actions">
          <button id="btn-play-audio">Play audio</button>
          <button class="btn-secondary" id="btn-next-lesson">Next</button>
        </div>
      </div>

      <div class="actions-row">
        <button id="btn-go-challenge" style="display:none;">Go to challenge ğŸ”¥</button>
        <button class="btn-secondary" id="btn-back-start">Back</button>
      </div>
    </div>

    <!-- CHALLENGE SCREEN -->
    <div id="screen-challenge" class="screen">
      <div id="top-bar">
        <span style="font-size:12px; color:#8a7bb8;">Challenge</span>
        <div id="progress-container">
          <div id="progress-bar-challenge"></div>
        </div>
        <span id="timer">6</span>
      </div>

      <div id="avatar-container">
        <img id="avatar-challenge" src="avatar_neutral.png" alt="avatar" />
      </div>

      <div id="challenge-word">word</div>

      <div id="options">
        <button class="option"></button>
        <button class="option"></button>
        <button class="option"></button>
        <button class="option"></button>
      </div>

      <div class="actions-row">
        <button class="btn-secondary" id="btn-exit-challenge">Exit</button>
      </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="screen-result" class="screen">
      <h2>Stage result</h2>
      <div class="center" style="margin-top:8px;">
        <div>Score: <strong id="final-score">0</strong></div>
        <div>Accuracy: <strong id="final-accuracy">0%</strong></div>
      </div>

      <div class="section">
        <h3 style="font-size:14px; margin-bottom:4px;">Wrong words</h3>
        <ul id="results-list"></ul>
      </div>

      <div class="actions-row">
        <button id="btn-repeat-wrong">Repeat wrong ğŸ”</button>
        <button class="btn-secondary" id="btn-play-again">Play again</button>
        <button class="btn-secondary" id="btn-back-home">Home</button>
      </div>
    </div>
  </div>

  <!-- SFX (optional) -->
  <audio id="sfx-correct" src="sfx_correct.mp3"></audio>
  <audio id="sfx-wrong" src="sfx_wrong.mp3"></audio>
  <audio id="sfx-click" src="sfx_click.mp3"></audio>

  <!-- ğŸ”¹ WORDS_DATA Ù…Ø³ØªÙ‚ÛŒÙ… Ø§ÛŒÙ†Ø¬Ø§Ø³Øª -->
  <script>
    const WORDS_DATA = {
      beginner: {
        daily: [
          { word: "hello", meaning: "Ø³Ù„Ø§Ù…", sentence: "Hello, how are you?" },
          { word: "goodbye", meaning: "Ø®Ø¯Ø§Ø­Ø§ÙØ¸", sentence: "Goodbye, see you later." },
          { word: "please", meaning: "Ù„Ø·ÙØ§Ù‹", sentence: "Please give me the book." },
          { word: "thanks", meaning: "Ù…ØªØ´Ú©Ø±Ù…", sentence: "Thanks for your help." },
          { word: "sorry", meaning: "Ø¨Ø¨Ø®Ø´ÛŒØ¯", sentence: "Sorry for being late." },
          { word: "yes", meaning: "Ø¨Ù„Ù‡", sentence: "Yes, I agree." },
          { word: "no", meaning: "Ù†Ù‡", sentence: "No, I don't want it." },
          { word: "friend", meaning: "Ø¯ÙˆØ³Øª", sentence: "He is my best friend." },
          { word: "family", meaning: "Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡", sentence: "My family is very important to me." },
          { word: "home", meaning: "Ø®Ø§Ù†Ù‡", sentence: "I am going home now." },
          { word: "school", meaning: "Ù…Ø¯Ø±Ø³Ù‡", sentence: "I walk to school every day." },
          { word: "work", meaning: "Ú©Ø§Ø±", sentence: "I work in an office." },
          { word: "happy", meaning: "Ø®ÙˆØ´Ø­Ø§Ù„", sentence: "I feel happy today." },
          { word: "sad", meaning: "ØºÙ…Ú¯ÛŒÙ†", sentence: "She looks sad." },
          { word: "tired", meaning: "Ø®Ø³ØªÙ‡", sentence: "I am tired after work." },
          { word: "morning", meaning: "ØµØ¨Ø­", sentence: "I wake up early in the morning." },
          { word: "night", meaning: "Ø´Ø¨", sentence: "Good night, sleep well." },
          { word: "today", meaning: "Ø§Ù…Ø±ÙˆØ²", sentence: "Today is a good day." },
          { word: "tomorrow", meaning: "ÙØ±Ø¯Ø§", sentence: "I will call you tomorrow." },
          { word: "yesterday", meaning: "Ø¯ÛŒØ±ÙˆØ²", sentence: "Yesterday was fun." },
          { word: "water", meaning: "Ø¢Ø¨", sentence: "I need some water." },
          { word: "phone", meaning: "ØªÙ„ÙÙ†", sentence: "My phone is charging." },
          { word: "time", meaning: "Ø²Ù…Ø§Ù†", sentence: "What time is it?" },
          { word: "money", meaning: "Ù¾ÙˆÙ„", sentence: "I don't have enough money." },
          { word: "love", meaning: "Ø¹Ø´Ù‚", sentence: "I love my family." },
          { word: "name", meaning: "Ù†Ø§Ù…", sentence: "What is your name?" },
          { word: "city", meaning: "Ø´Ù‡Ø±", sentence: "This city is beautiful." },
          { word: "street", meaning: "Ø®ÛŒØ§Ø¨Ø§Ù†", sentence: "I live on this street." },
          { word: "car", meaning: "Ù…Ø§Ø´ÛŒÙ†", sentence: "My car is new." },
          { word: "bus", meaning: "Ø§ØªÙˆØ¨ÙˆØ³", sentence: "The bus is late." },
          { word: "walk", meaning: "Ø±Ø§Ù‡ Ø±ÙØªÙ†", sentence: "I walk every morning." },
          { word: "run", meaning: "Ø¯ÙˆÛŒØ¯Ù†", sentence: "I run to stay healthy." },
          { word: "read", meaning: "Ø®ÙˆØ§Ù†Ø¯Ù†", sentence: "I read books at night." }
        ],
        food: [
          { word: "apple", meaning: "Ø³ÛŒØ¨", sentence: "I eat an apple every day." },
          { word: "banana", meaning: "Ù…ÙˆØ²", sentence: "Bananas are yellow." },
          { word: "orange", meaning: "Ù¾Ø±ØªÙ‚Ø§Ù„", sentence: "I like orange juice." },
          { word: "bread", meaning: "Ù†Ø§Ù†", sentence: "I bought fresh bread." },
          { word: "rice", meaning: "Ø¨Ø±Ù†Ø¬", sentence: "We eat rice for lunch." },
          { word: "egg", meaning: "ØªØ®Ù…â€ŒÙ…Ø±Øº", sentence: "I had eggs for breakfast." },
          { word: "milk", meaning: "Ø´ÛŒØ±", sentence: "Milk is good for health." },
          { word: "tea", meaning: "Ú†Ø§ÛŒ", sentence: "I drink tea every morning." },
          { word: "coffee", meaning: "Ù‚Ù‡ÙˆÙ‡", sentence: "Coffee wakes me up." },
          { word: "chicken", meaning: "Ù…Ø±Øº", sentence: "I like grilled chicken." },
          { word: "meat", meaning: "Ú¯ÙˆØ´Øª", sentence: "Meat is expensive." },
          { word: "fish", meaning: "Ù…Ø§Ù‡ÛŒ", sentence: "Fish is healthy." },
          { word: "soup", meaning: "Ø³ÙˆÙ¾", sentence: "I made vegetable soup." },
          { word: "salad", meaning: "Ø³Ø§Ù„Ø§Ø¯", sentence: "I eat salad every night." },
          { word: "pizza", meaning: "Ù¾ÛŒØªØ²Ø§", sentence: "Pizza is my favorite food." },
          { word: "burger", meaning: "Ø¨Ø±Ú¯Ø±", sentence: "I ordered a burger." },
          { word: "cheese", meaning: "Ù¾Ù†ÛŒØ±", sentence: "Cheese is delicious." },
          { word: "butter", meaning: "Ú©Ø±Ù‡", sentence: "I put butter on bread." },
          { word: "salt", meaning: "Ù†Ù…Ú©", sentence: "Add some salt." },
          { word: "sugar", meaning: "Ø´Ú©Ø±", sentence: "Too much sugar is bad." },
          { word: "juice", meaning: "Ø¢Ø¨Ù…ÛŒÙˆÙ‡", sentence: "I like fresh juice." },
          { word: "watermelon", meaning: "Ù‡Ù†Ø¯ÙˆØ§Ù†Ù‡", sentence: "Watermelon is sweet." },
          { word: "grape", meaning: "Ø§Ù†Ú¯ÙˆØ±", sentence: "Grapes are tasty." },
          { word: "lemon", meaning: "Ù„ÛŒÙ…Ùˆ", sentence: "Lemon is sour." },
          { word: "tomato", meaning: "Ú¯ÙˆØ¬Ù‡", sentence: "Tomatoes are red." },
          { word: "potato", meaning: "Ø³ÛŒØ¨â€ŒØ²Ù…ÛŒÙ†ÛŒ", sentence: "Potatoes are cheap." },
          { word: "onion", meaning: "Ù¾ÛŒØ§Ø²", sentence: "Onions make me cry." },
          { word: "carrot", meaning: "Ù‡ÙˆÛŒØ¬", sentence: "Carrots are orange." },
          { word: "pepper", meaning: "ÙÙ„ÙÙ„", sentence: "Pepper is spicy." },
          { word: "ice cream", meaning: "Ø¨Ø³ØªÙ†ÛŒ", sentence: "I love ice cream." },
          { word: "chocolate", meaning: "Ø´Ú©Ù„Ø§Øª", sentence: "Chocolate is sweet." },
          { word: "cookie", meaning: "Ú©ÙˆÚ©ÛŒ", sentence: "I baked cookies." },
          { word: "honey", meaning: "Ø¹Ø³Ù„", sentence: "Honey is natural sugar." }
        ],
        travel: [
          { word: "ticket", meaning: "Ø¨Ù„ÛŒØª", sentence: "I bought a ticket to Paris." },
          { word: "airport", meaning: "ÙØ±ÙˆØ¯Ú¯Ø§Ù‡", sentence: "The airport is crowded." },
          { word: "flight", meaning: "Ù¾Ø±ÙˆØ§Ø²", sentence: "My flight is delayed." },
          { word: "hotel", meaning: "Ù‡ØªÙ„", sentence: "We booked a hotel room." },
          { word: "room", meaning: "Ø§ØªØ§Ù‚", sentence: "Our room is clean." },
          { word: "passport", meaning: "Ù¾Ø§Ø³Ù¾ÙˆØ±Øª", sentence: "Don't forget your passport." },
          { word: "bag", meaning: "Ú©ÛŒÙ", sentence: "My bag is heavy." },
          { word: "map", meaning: "Ù†Ù‚Ø´Ù‡", sentence: "I need a map." },
          { word: "train", meaning: "Ù‚Ø·Ø§Ø±", sentence: "The train is fast." },
          { word: "station", meaning: "Ø§ÛŒØ³ØªÚ¯Ø§Ù‡", sentence: "Meet me at the station." },
          { word: "bus", meaning: "Ø§ØªÙˆØ¨ÙˆØ³", sentence: "The bus arrives soon." },
          { word: "taxi", meaning: "ØªØ§Ú©Ø³ÛŒ", sentence: "We took a taxi." },
          { word: "city", meaning: "Ø´Ù‡Ø±", sentence: "This city is beautiful." },
          { word: "country", meaning: "Ú©Ø´ÙˆØ±", sentence: "I love this country." },
          { word: "beach", meaning: "Ø³Ø§Ø­Ù„", sentence: "The beach is relaxing." },
          { word: "sea", meaning: "Ø¯Ø±ÛŒØ§", sentence: "The sea is blue." },
          { word: "mountain", meaning: "Ú©ÙˆÙ‡", sentence: "The mountain is high." },
          { word: "island", meaning: "Ø¬Ø²ÛŒØ±Ù‡", sentence: "We visited an island." },
          { word: "tour", meaning: "ØªÙˆØ±", sentence: "We joined a city tour." },
          { word: "guide", meaning: "Ø±Ø§Ù‡Ù†Ù…Ø§", sentence: "The guide was helpful." },
          { word: "camera", meaning: "Ø¯ÙˆØ±Ø¨ÛŒÙ†", sentence: "I forgot my camera." },
          { word: "photo", meaning: "Ø¹Ú©Ø³", sentence: "I took many photos." },
          { word: "travel", meaning: "Ø³ÙØ±", sentence: "I love to travel." },
          { word: "visit", meaning: "Ø¨Ø§Ø²Ø¯ÛŒØ¯", sentence: "We visited a museum." },
          { word: "museum", meaning: "Ù…ÙˆØ²Ù‡", sentence: "The museum was amazing." },
          { word: "park", meaning: "Ù¾Ø§Ø±Ú©", sentence: "We walked in the park." },
          { word: "bridge", meaning: "Ù¾Ù„", sentence: "The bridge is long." },
          { word: "road", meaning: "Ø¬Ø§Ø¯Ù‡", sentence: "The road is empty." },
          { word: "car", meaning: "Ù…Ø§Ø´ÛŒÙ†", sentence: "We rented a car." },
          { word: "driver", meaning: "Ø±Ø§Ù†Ù†Ø¯Ù‡", sentence: "The driver was friendly." },
          { word: "bag", meaning: "Ú†Ù…Ø¯Ø§Ù†", sentence: "My bag is full." },
          { word: "airport bus", meaning: "Ø§ØªÙˆØ¨ÙˆØ³ ÙØ±ÙˆØ¯Ú¯Ø§Ù‡", sentence: "We took the airport bus." },
          { word: "check-in", meaning: "Ú†Ú©â€ŒØ§ÛŒÙ†", sentence: "We checked in early." }
        ]
      },
      intermediate: {
        daily: [],
        food: [],
        travel: []
      }
    };
  </script>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    let currentLevel = "beginner";
    let currentTopic = "daily";
    let lessons = [];
    let currentLessonIndex = 0;

    let questions = [];
    let currentQuestionIndex = 0;
    let wrongWords = [];
    let score = 0;
    let totalQuestions = 0;
    let correctAnswers = 0;
    let timerInterval = null;
    const timePerQuestion = 6;

    // -----------------------------
    // Elements
    // -----------------------------
    const screenStart = document.getElementById("screen-start");
    const screenLearn = document.getElementById("screen-learn");
    const screenChallenge = document.getElementById("screen-challenge");
    const screenResult = document.getElementById("screen-result");

    const levelChips = document.getElementById("level-chips");
    const topicChips = document.getElementById("topic-chips");

    const btnStartLearn = document.getElementById("btn-start-learn");

    const progressBarLearn = document.getElementById("progress-bar");
    const progressLabelLearn = document.getElementById("progress-label");

    const lessonImg = document.getElementById("lesson-img");
    const lessonWord = document.getElementById("lesson-word");
    const lessonMeaning = document.getElementById("lesson-meaning");
    const lessonSentence = document.getElementById("lesson-sentence");
    const btnPlayAudio = document.getElementById("btn-play-audio");
    const btnNextLesson = document.getElementById("btn-next-lesson");
    const btnGoChallenge = document.getElementById("btn-go-challenge");
    const btnBackStart = document.getElementById("btn-back-start");

    const avatarLearn = document.getElementById("avatar-learn");
    const avatarChallenge = document.getElementById("avatar-challenge");

    const progressBarChallenge = document.getElementById("progress-bar-challenge");
    const timerLabel = document.getElementById("timer");
    const challengeWord = document.getElementById("challenge-word");
    const optionButtons = document.querySelectorAll(".option");
    const btnExitChallenge = document.getElementById("btn-exit-challenge");

    const finalScoreLabel = document.getElementById("final-score");
    const finalAccuracyLabel = document.getElementById("final-accuracy");
    const resultsList = document.getElementById("results-list");
    const btnRepeatWrong = document.getElementById("btn-repeat-wrong");
    const btnPlayAgain = document.getElementById("btn-play-again");
    const btnBackHome = document.getElementById("btn-back-home");

    const sfxCorrect = document.getElementById("sfx-correct");
    const sfxWrong = document.getElementById("sfx-wrong");
    const sfxClick = document.getElementById("sfx-click");

    // -----------------------------
    // Helpers
    // -----------------------------
    function showScreen(screen) {
      [screenStart, screenLearn, screenChallenge, screenResult].forEach(s => s.classList.remove("active"));
      screen.classList.add("active");
    }

    function playSfx(audioEl) {
      if (!audioEl) return;
      audioEl.currentTime = 0;
      audioEl.play().catch(() => {});
    }

    function setAvatarMood(targetImg, mood) {
      let src = "avatar_neutral.png";
      if (mood === "sad") src = "avatar_sad.png";
      else if (mood === "happy") src = "avatar_happy.png";
      else if (mood === "super-happy") src = "avatar_super_happy.png";

      targetImg.src = src;
      targetImg.classList.remove("avatar-bounce");
      void targetImg.offsetWidth;
      targetImg.classList.add("avatar-bounce");
    }

    function updateLearnProgress() {
      const total = lessons.length || 1;
      const current = currentLessonIndex + 1;
      const percent = (current / total) * 100;
      progressBarLearn.style.width = percent + "%";
      progressLabelLearn.textContent = current + " / " + total;
    }

    function updateChallengeProgress() {
      const total = totalQuestions || 1;
      const current = currentQuestionIndex;
      const percent = (current / total) * 100;
      progressBarChallenge.style.width = percent + "%";
    }

    // -----------------------------
    // Level & topic selection
    // -----------------------------
    levelChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      levelChips.querySelectorAll(".chip").forEach(c => c.classList.remove("selected"));
      chip.classList.add("selected");
      currentLevel = chip.dataset.level;
      playSfx(sfxClick);
    });

    topicChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      topicChips.querySelectorAll(".chip").forEach(c => c.classList.remove("selected"));
      chip.classList.add("selected");
      currentTopic = chip.dataset.topic;
      playSfx(sfxClick);
    });

    // -----------------------------
    // Start learning
    // -----------------------------
    btnStartLearn.addEventListener("click", () => {
      playSfx(sfxClick);
      const levelData = WORDS_DATA[currentLevel] || {};
      lessons = levelData[currentTopic] || [];
      if (!lessons.length) {
        alert("No words for this level/topic yet.");
        return;
      }
      currentLessonIndex = 0;
      showScreen(screenLearn);
      setAvatarMood(avatarLearn, "neutral");
      showLesson();
    });

    btnBackStart.addEventListener("click", () => {
      playSfx(sfxClick);
      showScreen(screenStart);
    });

    function showLesson() {
      const l = lessons[currentLessonIndex];
      lessonImg.src = l.image || "placeholder.png";
      lessonWord.textContent = l.word;
      lessonMeaning.textContent = l.meaning;
      lessonSentence.textContent = l.sentence;
      btnGoChallenge.style.display = (currentLessonIndex >= lessons.length - 1) ? "inline-block" : "none";
      updateLearnProgress();
    }

    btnNextLesson.addEventListener("click", () => {
      playSfx(sfxClick);
      if (currentLessonIndex < lessons.length - 1) {
        currentLessonIndex++;
        showLesson();
      } else {
        setAvatarMood(avatarLearn, "happy");
        btnGoChallenge.style.display = "inline-block";
      }
    });

    btnPlayAudio.addEventListener("click", () => {
      playSfx(sfxClick);
      const l = lessons[currentLessonIndex];
      if (!l.audio) return;
      const audio = new Audio(l.audio);
      audio.play().catch(() => {});
    });

    btnGoChallenge.addEventListener("click", () => {
      playSfx(sfxClick);
      startChallenge(false);
    });

    // -----------------------------
    // Challenge
    // -----------------------------
    function startChallenge(fromWrongOnly) {
      showScreen(screenChallenge);
      setAvatarMood(avatarChallenge, "neutral");
      score = 0;
      correctAnswers = 0;

      if (fromWrongOnly && wrongWords.length) {
        questions = [...wrongWords];
        wrongWords = [];
      } else {
        questions = [...lessons];
        wrongWords = [];
      }

      totalQuestions = questions.length;
      currentQuestionIndex = 0;
      progressBarChallenge.style.width = "0%";
      loadQuestion();
    }

    function loadQuestion() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (currentQuestionIndex >= questions.length) {
        endChallenge();
        return;
      }

      updateChallengeProgress();

      const q = questions[currentQuestionIndex];
      challengeWord.textContent = q.word;

      let options = [q.meaning];
      while (options.length < 4 && lessons.length > 1) {
        let random = lessons[Math.floor(Math.random() * lessons.length)].meaning;
        if (!options.includes(random)) options.push(random);
      }
      while (options.length < 4) {
        options.push("â€”");
      }

      options.sort(() => Math.random() - 0.5);

      optionButtons.forEach((btn, i) => {
        btn.disabled = false;
        btn.classList.remove("correct", "wrong");
        btn.textContent = options[i];
        btn.onclick = () => checkAnswer(options[i] === q.meaning, q, btn);
      });

      startTimer();
    }

    function startTimer() {
      let timeLeft = timePerQuestion;
      timerLabel.textContent = timeLeft;
      timerInterval = setInterval(() => {
        timeLeft--;
        timerLabel.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          handleTimeout();
        }
      }, 1000);
    }

    function handleTimeout() {
      const q = questions[currentQuestionIndex];
      wrongWords.push(q);
      setAvatarMood(avatarChallenge, "sad");
      playSfx(sfxWrong);
      optionButtons.forEach(btn => btn.disabled = true);
      setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
      }, 700);
    }

    function checkAnswer(isCorrect, wordObj, btn) {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      optionButtons.forEach(b => b.disabled = true);

      if (isCorrect) {
        score += 10;
        correctAnswers++;
        btn.classList.add("correct");
        setAvatarMood(avatarChallenge, "happy");
        playSfx(sfxCorrect);
      } else {
        score -= 5;
        wrongWords.push(wordObj);
        btn.classList.add("wrong");
        setAvatarMood(avatarChallenge, "sad");
        playSfx(sfxWrong);
      }

      setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
      }, 700);
    }

    function endChallenge() {
      showScreen(screenResult);
      finalScoreLabel.textContent = score;
      const accuracy = totalQuestions ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
      finalAccuracyLabel.textContent = accuracy + "%";

      resultsList.innerHTML = "";
      if (!wrongWords.length) {
        const li = document.createElement("li");
        li.textContent = "No wrong words. Great job! ğŸ‰";
        resultsList.appendChild(li);
      } else {
        wrongWords.forEach(w => {
          const li = document.createElement("li");
          li.textContent = w.word + " = " + w.meaning;
          resultsList.appendChild(li);
        });
      }
    }

    btnExitChallenge.addEventListener("click", () => {
      playSfx(sfxClick);
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      showScreen(screenStart);
    });

    btnRepeatWrong.addEventListener("click", () => {
      playSfx(sfxClick);
      if (!wrongWords.length) {
        alert("No wrong words to repeat.");
        return;
      }
      startChallenge(true);
    });

    btnPlayAgain.addEventListener("click", () => {
      playSfx(sfxClick);
      startChallenge(false);
    });

    btnBackHome.addEventListener("click", () => {
      playSfx(sfxClick);
      showScreen(screenStart);
    });
  </script>
</body>
</html>
